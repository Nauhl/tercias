<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Cartas Online</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f4c3a, #2d8659);
        }
        .login-form {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        .login-form input {
            padding: 10px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            width: 200px;
        }
        .waiting-room {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            margin: 20px;
        }
        .reset-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
        }
        .reset-btn:hover {
            background: #b91c1c;
        }
        .ad-container {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            min-height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .donation-btn {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 14px;
        }
        .card.playable {
            border: 2px solid #22c55e;
            cursor: pointer;
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .card.joker {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
        }
        .card.selected {
            border: 3px solid #fbbf24;
            transform: translateY(-10px);
            box-shadow: 0 6px 12px rgba(251, 191, 36, 0.5);
        }
        .rules-summary {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: left;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }
        .rules-summary h4 {
            margin: 0 0 10px 0;
            color: #22c55e;
        }
        .rules-summary ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .rules-summary li {
            margin: 5px 0;
            line-height: 1.4;
        }
        #wildcardModal .modal-content {
            max-width: 500px;
            text-align: center;
        }
        .wildcard-effect {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid #22c55e;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .card-area {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
        }
        .card-area h4 {
            margin: 0 0 10px 0;
            color: #22c55e;
            font-size: 14px;
        }
        .setup-instruction {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Pantalla de login -->
    <div id="loginScreen" class="login-screen">
        <div class="login-form">
            <h1>ğŸƒ Tercias Online</h1>
            <p>Ingresa tu nombre para jugar</p>
            <input type="text" id="playerName" placeholder="Tu nombre" maxlength="15">
            <br>
            <button onclick="joinGame()">Unirse al Juego</button>
        </div>
    </div>
    
    <!-- Sala de espera -->
    <div id="waitingRoom" class="waiting-room" style="display: none;">
        <h2>ğŸ• Sala de Espera</h2>
        <div id="playersList"></div>
        <p>Jugadores conectados: <span id="playerCount">0</span> (MÃ­nimo 2, MÃ¡ximo 5)</p>
        
        <!-- Resumen de reglas -->
        <div class="rules-summary">
            <h4>ğŸ¯ Reglas rÃ¡pidas de Tercias:</h4>
            <ul>
                <li>ğŸ¯ 3 cartas boca abajo, 3 boca arriba, 3 en mano</li>
                <li>ğŸƒ Juega carta igual o mayor valor</li>
                <li>ğŸ”„ Mantienes 3 cartas en mano (si hay mazo)</li>
                <li>ğŸ½ï¸ Si no puedes jugar, "comes" todas las cartas del centro</li>
                <li>ğŸ”¢ Puedes jugar mÃºltiples cartas del mismo valor</li>
                <li>ğŸ† Gana eliminando todas tus cartas: mano â†’ boca arriba â†’ boca abajo</li>
            </ul>
            <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin-top: 10px;">
                <strong>ğŸƒ Comodines:</strong> 2=Paso, 8=Reversa, 10=Barre, Joker=ComodÃ­n<br>
                <strong>ğŸ“Š Orden:</strong> 3, 4, 5, 6, 7, 9, J, Q, K, As (mÃ¡s alto)
            </div>
        </div>
        
        <!-- Espacio publicitario -->
        <div class="ad-container">
            <!-- AquÃ­ va tu cÃ³digo de AdSense -->
            <div style="color: rgba(255,255,255,0.7); font-size: 12px;">ğŸ’¡ Apoya el juego</div>
        </div>
        
        <button id="startGameBtn" style="display: none; margin-top: 15px; padding: 10px 20px; font-size: 16px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ® Iniciar Juego</button>
        <button id="resetRoomBtn" class="reset-btn">ğŸ”„ Limpiar Sala</button>
        <button class="donation-btn" onclick="window.open('https://paypal.me/tuusuario', '_blank')">â˜• Donar</button>
    </div>
    
    <!-- Juego principal -->
    <div id="gameScreen" class="container" style="display: none;">
        <header>
            <h1>Tercias Online</h1>
            <button id="infoBtn" class="info-btn">â„¹ï¸ CÃ³mo Jugar</button>
        </header>
        
        <div class="scoreboard">
            <h3>ğŸ† Ranking de Jugadores</h3>
            <div class="players-scores" id="playersScores"></div>
        </div>
        
        <div class="current-player">
            <h3>Turno de: <span id="currentPlayerName">-</span></h3>
        </div>
        
        <main class="game-area">
            <div class="deck-area">
                <div class="deck" id="deck">
                    <div class="card card-back">Mazo<br><span id="cardsLeft">52</span></div>
                </div>
            </div>
            
            <div class="play-area" id="playArea"></div>
            
            <div class="player-hand" id="playerHand"></div>
        </main>
        
        <div class="controls">
            <button id="endTurnBtn">No puedo jugar (Comer cartas)</button>
            <div id="gameInstructions" style="margin: 10px 0; font-size: 14px; color: #666;">
                Haz clic en las cartas para seleccionarlas. Puedes seleccionar mÃºltiples cartas del mismo valor.
            </div>
        </div>
    </div>
    
    <!-- Modal de victoria -->
    <div id="victoryModal" class="victory-modal">
        <div class="victory-content">
            <h1>ğŸ‰ Â¡VICTORIA! ğŸ‰</h1>
            <div class="winner-info" id="winnerInfo"></div>
            <button class="victory-button" id="playAgainBtn">ğŸ® Jugar de Nuevo</button>
        </div>
        <div class="confetti" style="left: 10%;"></div>
        <div class="confetti" style="left: 20%;"></div>
        <div class="confetti" style="left: 30%;"></div>
        <div class="confetti" style="left: 40%;"></div>
        <div class="confetti" style="left: 50%;"></div>
        <div class="confetti" style="left: 60%;"></div>
        <div class="confetti" style="left: 70%;"></div>
        <div class="confetti" style="left: 80%;"></div>
        <div class="confetti" style="left: 90%;"></div>
    </div>
    
    <!-- Modal de informaciÃ³n -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>ğŸ“‹ CÃ³mo Jugar Tercias</h2>
            <div class="rules">
                <h3>ğŸ¯ Objetivo:</h3>
                <p>Eliminar todas tus cartas para ganar.</p>
                
                <h3>ğŸ® ConfiguraciÃ³n inicial:</h3>
                <ul>
                    <li>Cada jugador recibe 9 cartas: 3 boca abajo, 3 boca arriba, 3 en mano</li>
                    <li>Puedes intercambiar cartas entre tu mano y las boca arriba antes de empezar</li>
                    <li>El jugador con la carta mÃ¡s baja (3) en su mano empieza</li>
                </ul>
                
                <h3>ğŸ¯ Reglas de juego:</h3>
                <ul>
                    <li>Juega carta igual o mayor valor que la del centro</li>
                    <li>Mantienes 3 cartas en mano mientras haya mazo</li>
                    <li>Si no puedes jugar, "comes" todas las cartas del centro</li>
                    <li>Puedes jugar mÃºltiples cartas del mismo valor</li>
                    <li>Secuencia: usa mano â†’ cartas boca arriba â†’ cartas boca abajo</li>
                </ul>
                
                <h3>ğŸƒ Cartas Especiales:</h3>
                <ul>
                    <li><strong>2:</strong> Paso - el siguiente jugador pierde turno</li>
                    <li><strong>8:</strong> Reversa - cambia direcciÃ³n del juego</li>
                    <li><strong>10:</strong> Barre - elimina todas las cartas del centro</li>
                    <li><strong>Joker:</strong> ComodÃ­n - tÃº decides su valor</li>
                </ul>
                
                <h3>ğŸ“Š Orden de cartas:</h3>
                <p><strong>De menor a mayor:</strong> 3, 4, 5, 6, 7, 9, J, Q, K, As</p>
                <p><strong>Comodines:</strong> 2, 8, 10, Joker (se pueden jugar sobre cualquier carta)</p>
                
                <h3>ğŸ CÃ³mo ganar:</h3>
                <ol>
                    <li>Elimina todas las cartas de tu mano</li>
                    <li>Luego usa las 3 cartas boca arriba</li>
                    <li>Finalmente usa las 3 cartas boca abajo (sin verlas antes)</li>
                    <li>Â¡Ganas al jugar tu Ãºltima carta sin tener que "comer"!</li>
                </ol>
            </div>
        </div>
    </div>
    
    <!-- Modal de comodÃ­n -->
    <div id="wildcardModal" class="modal">
        <div class="modal-content">
            <span class="close-wildcard">&times;</span>
            <h2 id="wildcardTitle">ğŸƒ Carta Especial</h2>
            <div id="wildcardContent" class="rules">
                <!-- Contenido dinÃ¡mico -->
            </div>
            <button id="wildcardOkBtn" style="background: #22c55e; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 16px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">âœ¨ Â¡Entendido!</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAODDKrWgFHsOoTyS4CIeF6m83nADUfzyo",
            authDomain: "cartablas-game.firebaseapp.com",
            databaseURL: "https://cartablas-game-default-rtdb.firebaseio.com",
            projectId: "cartablas-game",
            storageBucket: "cartablas-game.firebasestorage.app",
            messagingSenderId: "986320435667",
            appId: "1:986320435667:web:075fa8945c8036b479d726",
            measurementId: "G-F8T0SGYWN2"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let myPlayerId = null;
        let gameRoom = 'room_' + Math.random().toString(36).substr(2, 9); // Sala Ãºnica por sesiÃ³n
        let gameData = { players: {}, currentPlayer: 0, deck: [], gameStarted: false };
        
        // Limpiar sala al cargar la pÃ¡gina
        window.addEventListener('load', () => {
            const gameRef = ref(database, `games/${gameRoom}`);
            remove(gameRef);
        });
        
        // Unirse al juego
        window.joinGame = function() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Ingresa tu nombre');
                return;
            }
            
            myPlayerId = 'player_' + Date.now();
            const playerRef = ref(database, `games/${gameRoom}/players/${myPlayerId}`);
            
            set(playerRef, {
                name: playerName,
                score: 0,
                hand: [],
                joinedAt: Date.now()
            }).then(() => {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('waitingRoom').style.display = 'block';
                listenToGame();
            });
        };
        
        // Limpiar sala
        window.resetRoom = function() {
            const gameRef = ref(database, `games/${gameRoom}`);
            remove(gameRef).then(() => {
                location.reload();
            });
        };
        
        // Escuchar cambios del juego
        function listenToGame() {
            const gameRef = ref(database, `games/${gameRoom}`);
            onValue(gameRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    gameData = data;
                    updateUI();
                }
            });
        }
        
        function updateUI() {
            const players = Object.values(gameData.players || {});
            
            if (!gameData.gameStarted) {
                updateWaitingRoom(players);
            } else {
                showGameScreen();
                updateGameUI();
            }
        }
        
        function updateWaitingRoom(players) {
            // Limitar a mÃ¡ximo 5 jugadores
            const activePlayers = players.slice(0, 5);
            
            document.getElementById('playersList').innerHTML = activePlayers.map((p, i) => 
                `<div style="padding: 5px; background: rgba(255,255,255,0.1); margin: 5px 0; border-radius: 5px;">
                    ${i + 1}. ${p.name} ${p.id === myPlayerId ? '(TÃº)' : ''}
                </div>`
            ).join('');
            
            document.getElementById('playerCount').textContent = activePlayers.length;
            
            const startGameBtn = document.getElementById('startGameBtn');
            if (activePlayers.length >= 2 && Object.keys(gameData.players || {})[0] === myPlayerId) {
                startGameBtn.style.display = 'block';
            } else {
                startGameBtn.style.display = 'none';
            }
        }
        
        window.startGame = function() {
            const players = Object.keys(gameData.players || {}).slice(0, 5);
            if (players.length < 2) {
                alert('Se necesitan al menos 2 jugadores');
                return;
            }
            
            const deck = createDeck();
            const updates = {};
            let lowestCard = { value: 'A', playerId: null, order: 999 };
            
            players.forEach((playerId) => {
                const faceDown = [deck.pop(), deck.pop(), deck.pop()];
                const faceUp = [deck.pop(), deck.pop(), deck.pop()];
                const hand = [deck.pop(), deck.pop(), deck.pop()];
                
                // Encontrar la carta mÃ¡s baja en la mano para determinar quiÃ©n empieza
                hand.forEach(card => {
                    const order = getCardOrder(card.value);
                    if (order > 0 && order < lowestCard.order) {
                        lowestCard = { value: card.value, playerId: playerId, order: order };
                    }
                });
                
                updates[`games/${gameRoom}/players/${playerId}/faceDown`] = faceDown;
                updates[`games/${gameRoom}/players/${playerId}/faceUp`] = faceUp;
                updates[`games/${gameRoom}/players/${playerId}/hand`] = hand;
                updates[`games/${gameRoom}/players/${playerId}/totalCards`] = 9;
            });
            
            // Determinar jugador inicial
            const startingPlayerIndex = players.indexOf(lowestCard.playerId);
            
            updates[`games/${gameRoom}/deck`] = deck;
            updates[`games/${gameRoom}/playPile`] = [];
            updates[`games/${gameRoom}/gameStarted`] = true;
            updates[`games/${gameRoom}/currentPlayer`] = startingPlayerIndex;
            updates[`games/${gameRoom}/direction`] = 1;
            updates[`games/${gameRoom}/skipNext`] = false;
            updates[`games/${gameRoom}/gamePhase`] = 'setup'; // setup, playing
            updates[`games/${gameRoom}/setupComplete`] = {};
            
            Object.keys(updates).forEach(path => {
                set(ref(database, path), updates[path]);
            });
        };
        
        function showGameScreen() {
            document.getElementById('waitingRoom').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
        }
        
        function updateGameUI() {
            const players = Object.values(gameData.players || {});
            const playerIds = Object.keys(gameData.players || {});
            
            if (gameData.gamePhase === 'setup') {
                document.getElementById('currentPlayerName').textContent = 'Fase de preparaciÃ³n - Acomoda tus cartas';
                document.getElementById('playersScores').innerHTML = players.map((p, i) => `
                    <div class="player-score">
                        <div>ğŸ… ${p.name}</div>
                        <div>${gameData.setupComplete?.[playerIds[i]] ? 'âœ“ Listo' : 'â³ Preparando'}</div>
                    </div>
                `).join('');
            } else {
                document.getElementById('playersScores').innerHTML = players.map((p, i) => `
                    <div class="player-score ${i === gameData.currentPlayer ? 'active' : ''}">
                        <div>ğŸ… ${p.name}</div>
                        <div>${p.totalCards || 0} cartas</div>
                    </div>
                `).join('');
                
                if (players[gameData.currentPlayer]) {
                    document.getElementById('currentPlayerName').textContent = players[gameData.currentPlayer].name;
                }
            }
            
            const myPlayer = gameData.players[myPlayerId];
            if (myPlayer) {
                renderPlayerArea(myPlayer);
            }
            
            renderPlayArea();
            
            if (gameData.deck) {
                document.getElementById('cardsLeft').textContent = gameData.deck.length;
            }
            
            // Mostrar controles apropiados
            updateControls();
        }
        
        function renderPlayerArea(player) {
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            if (gameData.gamePhase === 'setup') {
                // Fase de preparaciÃ³n - permitir intercambio
                html += '<div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin-bottom: 10px;">';
                html += '<p><strong>ğŸ“ Fase de preparaciÃ³n:</strong> Haz clic en las cartas para intercambiar entre tu mano y las cartas boca arriba.</p>';
                html += '</div>';
                
                // Cartas boca arriba (intercambiables) - SOLO 3
                html += '<div><h4>Cartas boca arriba (haz clic para intercambiar):</h4><div style="display: flex; gap: 5px;">';
                (player.faceUp || []).slice(0, 3).forEach((card, index) => {
                    html += `<div class="card card-front ${card.color} playable" onclick="swapCard('faceUp', ${index})">
                        ${card.value}${card.suit}
                    </div>`;
                });
                html += '</div></div>';
                
                // Cartas en mano (intercambiables) - SOLO 3
                html += `<div><h4>Tu mano (haz clic para intercambiar):</h4><div style="display: flex; gap: 5px;">`;
                (player.hand || []).slice(0, 3).forEach((card, index) => {
                    html += `<div class="card card-front ${card.color} playable" onclick="swapCard('hand', ${index})">
                        ${card.value}${card.suit}
                    </div>`;
                });
                html += '</div></div>';
                
                // BotÃ³n para confirmar preparaciÃ³n
                const isReady = gameData.setupComplete?.[myPlayerId];
                html += `<button onclick="confirmSetup()" style="background: ${isReady ? '#dc2626' : '#22c55e'}; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                    ${isReady ? 'âŒ Cambiar cartas' : 'âœ“ Confirmar preparaciÃ³n'}
                </button>`;
            } else {
                // Juego normal - mostrar solo las cartas que se pueden usar
                const handCount = player.hand?.length || 0;
                const faceUpCount = player.faceUp?.length || 0;
                const faceDownCount = player.faceDown?.length || 0;
                
                // Solo mostrar cartas en mano si las hay - SOLO 3
                if (handCount > 0) {
                    html += `<div><h4>Tu mano (${handCount} cartas) - Usa estas primero:</h4><div style="display: flex; gap: 5px;">`;
                    (player.hand || []).slice(0, 3).forEach((card, index) => {
                        const isSelected = selectedCards.includes(index);
                        const canPlay = canPlayCard(card);
                        html += `<div class="card card-front ${card.color} ${canPlay ? 'playable' : 'disabled'} ${isSelected ? 'selected' : ''}" 
                                 ${canPlay ? `onclick="selectCard('hand', ${index})"` : ''}>
                            ${card.value}${card.suit}
                        </div>`;
                    });
                    html += '</div></div>';
                }
                // Solo mostrar cartas boca arriba si no hay cartas en mano - SOLO 3
                else if (faceUpCount > 0) {
                    html += `<div><h4>Cartas boca arriba (${faceUpCount}) - Ahora puedes usarlas:</h4><div style="display: flex; gap: 5px;">`;
                    (player.faceUp || []).slice(0, 3).forEach((card, index) => {
                        const canPlay = canPlayCard(card);
                        html += `<div class="card card-front ${card.color} ${canPlay ? 'playable' : 'disabled'}" 
                                 ${canPlay ? `onclick="selectCard('faceUp', ${index})"` : ''}>
                            ${card.value}${card.suit}
                        </div>`;
                    });
                    html += '</div></div>';
                }
                // Solo mostrar cartas boca abajo si no hay otras cartas
                else if (faceDownCount > 0) {
                    html += `<div><h4>Cartas boca abajo (${faceDownCount}) - Â¡Ãšltima oportunidad!:</h4><div style="display: flex; gap: 5px;">`;
                    for (let i = 0; i < faceDownCount; i++) {
                        html += `<div class="card card-back playable" onclick="playFaceDownCard(${i})">?</div>`;
                    }
                    html += '</div></div>';
                }
                else {
                    html += '<div><h4>Â¡Sin cartas! ğŸ‰</h4></div>';
                }
                
                // Mostrar informaciÃ³n de cartas no disponibles (solo como referencia)
                if (handCount > 0 && (faceUpCount > 0 || faceDownCount > 0)) {
                    html += `<div style="opacity: 0.5; margin-top: 15px;"><small>Tienes ${faceUpCount} cartas boca arriba y ${faceDownCount} boca abajo para despuÃ©s</small></div>`;
                }
            }
            
            html += '</div>';
            document.getElementById('playerHand').innerHTML = html;
        }
        
        let selectedCards = [];
        
        window.selectCard = function(source, index) {
            const playerIds = Object.keys(gameData.players);
            if (playerIds[gameData.currentPlayer] !== myPlayerId) return;
            
            if (source === 'hand') {
                const cardIndex = selectedCards.indexOf(index);
                if (cardIndex > -1) {
                    selectedCards.splice(cardIndex, 1); // Deseleccionar
                } else {
                    const myPlayer = gameData.players[myPlayerId];
                    const card = myPlayer.hand[index];
                    
                    // Solo permitir seleccionar cartas del mismo valor
                    if (selectedCards.length === 0) {
                        selectedCards.push(index);
                    } else {
                        const firstSelectedCard = myPlayer.hand[selectedCards[0]];
                        if (card.value === firstSelectedCard.value) {
                            selectedCards.push(index);
                        }
                    }
                }
                renderPlayerArea(gameData.players[myPlayerId]);
            } else {
                // Jugar carta boca arriba directamente
                playSelectedCards('faceUp', [index]);
            }
        };
        
        window.playSelectedCards = function(source = 'hand', indices = selectedCards) {
            if (indices.length === 0) return;
            
            const playerIds = Object.keys(gameData.players);
            if (playerIds[gameData.currentPlayer] !== myPlayerId) return;
            
            const myPlayer = gameData.players[myPlayerId];
            const cardArray = source === 'hand' ? myPlayer.hand : myPlayer.faceUp;
            const cardsToPlay = indices.map(i => cardArray[i]).filter(c => c);
            
            if (cardsToPlay.length === 0) return;
            
            // Verificar que se puede jugar al menos una carta
            if (!canPlayCard(cardsToPlay[0])) {
                eatCards();
                return;
            }
            
            // Remover cartas (en orden inverso para mantener Ã­ndices)
            indices.sort((a, b) => b - a).forEach(index => {
                if (cardArray[index]) {
                    const card = cardArray.splice(index, 1)[0];
                    const playPile = gameData.playPile || [];
                    playPile.push(card);
                    set(ref(database, `games/${gameRoom}/playPile`), playPile);
                    
                    // Aplicar efectos especiales
                    applyCardEffect(card);
                }
            });
            
            // Actualizar jugador
            myPlayer.totalCards = (myPlayer.faceDown?.length || 0) + 
                                 (myPlayer.faceUp?.length || 0) + 
                                 (myPlayer.hand?.length || 0);
            
            // Verificar victoria
            if (myPlayer.totalCards === 0) {
                showVictory(myPlayer.name, 'ğŸ¯ Â¡Sin cartas!');
                return;
            }
            
            // NO robar cartas automÃ¡ticamente - solo mantener las 3 iniciales
            // En Tercias no se roba del mazo, solo se usan las 9 cartas iniciales
            
            set(ref(database, `games/${gameRoom}/players/${myPlayerId}`), myPlayer);
            selectedCards = [];
            nextTurn();
        };
        
        function nextTurn() {
            const playerIds = Object.keys(gameData.players);
            let nextPlayerIndex;
            
            if (gameData.skipNext) {
                // Saltar el siguiente jugador
                nextPlayerIndex = (gameData.currentPlayer + (2 * gameData.direction) + playerIds.length) % playerIds.length;
                set(ref(database, `games/${gameRoom}/skipNext`), false);
            } else {
                nextPlayerIndex = (gameData.currentPlayer + gameData.direction + playerIds.length) % playerIds.length;
            }
            
            set(ref(database, `games/${gameRoom}/currentPlayer`), nextPlayerIndex);
        }
        
        window.endTurn = function() {
            const playerIds = Object.keys(gameData.players);
            if (playerIds[gameData.currentPlayer] !== myPlayerId) return;
            
            // Si no puedes jugar ninguna carta, debes comer
            const myPlayer = gameData.players[myPlayerId];
            let hasPlayableCard = false;
            
            // Verificar cartas en mano
            if ((myPlayer.hand?.length || 0) > 0) {
                hasPlayableCard = (myPlayer.hand || []).some(card => canPlayCard(card));
            }
            // Verificar cartas boca arriba si no hay cartas en mano
            else if ((myPlayer.faceUp?.length || 0) > 0) {
                hasPlayableCard = (myPlayer.faceUp || []).some(card => canPlayCard(card));
            }
            // Las cartas boca abajo siempre se pueden intentar jugar
            else if ((myPlayer.faceDown?.length || 0) > 0) {
                hasPlayableCard = true;
            }
            
            if (!hasPlayableCard) {
                eatCards();
            } else {
                alert('Tienes cartas que puedes jugar. Selecciona una carta vÃ¡lida.');
            }
        };
        
        window.eatCards = function() {
            const playerIds = Object.keys(gameData.players);
            if (playerIds[gameData.currentPlayer] !== myPlayerId) return;
            
            const myPlayer = gameData.players[myPlayerId];
            const playPile = gameData.playPile || [];
            
            if (playPile.length > 0) {
                // Agregar todas las cartas del centro a la mano
                myPlayer.hand = myPlayer.hand || [];
                myPlayer.hand.push(...playPile);
                myPlayer.totalCards = (myPlayer.faceDown?.length || 0) + 
                                     (myPlayer.faceUp?.length || 0) + 
                                     myPlayer.hand.length;
                
                // Limpiar pila de juego
                set(ref(database, `games/${gameRoom}/playPile`), []);
                set(ref(database, `games/${gameRoom}/players/${myPlayerId}`), myPlayer);
                
                alert(`Â¡Comiste ${playPile.length} cartas! Ahora tienes ${myPlayer.hand.length} cartas en mano.`);
            }
            
            nextTurn();
        };
        
        function showVictory(winnerName, message) {
            document.getElementById('winnerInfo').innerHTML = `
                <div>ğŸ† <strong>${winnerName}</strong> ğŸ†</div>
                <div style="font-size: 0.8em; margin-top: 10px;">${message}</div>
            `;
            document.getElementById('victoryModal').style.display = 'block';
        }
        
        function createDeck() {
            const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
            const values = ['3', '4', '5', '6', '7', '9', 'J', 'Q', 'K', 'A', '2', '8', '10'];
            const deck = [];
            
            for (let suit of suits) {
                for (let value of values) {
                    deck.push({
                        suit: suit,
                        value: value,
                        color: (suit === 'â™¥' || suit === 'â™¦') ? 'red' : 'black'
                    });
                }
            }
            
            // Agregar 2 Jokers
            deck.push({ suit: 'ğŸƒ', value: 'Joker', color: 'joker' });
            deck.push({ suit: 'ğŸƒ', value: 'Joker', color: 'joker' });
            
            // Barajar
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            
            return deck;
        }
        
        function getCardOrder(value) {
            const order = { '3': 1, '4': 2, '5': 3, '6': 4, '7': 5, '9': 6, 'J': 7, 'Q': 8, 'K': 9, 'A': 10, '2': 0, '8': 0, '10': 0, 'Joker': 0 };
            return order[value] || 0;
        }
        
        function canPlayCard(card) {
            const playerIds = Object.keys(gameData.players);
            if (playerIds[gameData.currentPlayer] !== myPlayerId) return false;
            
            const playPile = gameData.playPile || [];
            if (playPile.length === 0) return true;
            
            const topCard = playPile[playPile.length - 1];
            
            // Cartas especiales siempre se pueden jugar
            if (['2', '8', '10', 'Joker'].includes(card.value)) return true;
            
            // Carta normal debe ser igual o mayor que la carta superior
            const cardOrder = getCardOrder(card.value);
            const topOrder = getCardOrder(topCard.value);
            
            // Si la carta superior es especial, cualquier carta se puede jugar
            if (topOrder === 0) return true;
            
            return cardOrder >= topOrder;
        }
        
        function updateControls() {
            const playerIds = Object.keys(gameData.players);
            const isMyTurn = playerIds[gameData.currentPlayer] === myPlayerId;
            const myPlayer = gameData.players[myPlayerId];
            
            if (gameData.gamePhase === 'setup') {
                // Fase de preparaciÃ³n - ocultar controles de juego
                document.getElementById('endTurnBtn').style.display = 'none';
                document.getElementById('gameInstructions').innerHTML = 'ğŸ“ <strong>Fase de preparaciÃ³n:</strong> Intercambia cartas entre tu mano y las boca arriba. Confirma cuando estÃ©s listo.';
                
                let playBtn = document.getElementById('playSelectedBtn');
                if (playBtn) playBtn.style.display = 'none';
            } else {
                // Juego normal
                document.getElementById('endTurnBtn').style.display = 'block';
                document.getElementById('endTurnBtn').textContent = isMyTurn ? 'No puedo jugar (Comer cartas)' : 'Esperar turno';
                document.getElementById('endTurnBtn').disabled = !isMyTurn;
                
                // Cambiar color del botÃ³n segÃºn el estado
                document.getElementById('endTurnBtn').style.background = isMyTurn ? '#dc2626' : '#6b7280';
                document.getElementById('endTurnBtn').style.cursor = isMyTurn ? 'pointer' : 'not-allowed';
                const myPlayer = gameData.players[myPlayerId];
                let instruction = 'Haz clic en las cartas para seleccionarlas. ';
                
                if ((myPlayer?.hand?.length || 0) > 0) {
                    instruction += 'Usando cartas de tu mano.';
                } else if ((myPlayer?.faceUp?.length || 0) > 0) {
                    instruction += 'Usando cartas boca arriba.';
                } else if ((myPlayer?.faceDown?.length || 0) > 0) {
                    instruction += 'Usando cartas boca abajo (Â¡cuidado, no las ves!).';
                }
                
                document.getElementById('gameInstructions').innerHTML = instruction;
                
                // BotÃ³n para jugar cartas seleccionadas
                let playBtn = document.getElementById('playSelectedBtn');
                if (!playBtn) {
                    playBtn = document.createElement('button');
                    playBtn.id = 'playSelectedBtn';
                    playBtn.textContent = 'Jugar Cartas Seleccionadas';
                    playBtn.onclick = () => playSelectedCards();
                    document.querySelector('.controls').appendChild(playBtn);
                }
                playBtn.style.display = isMyTurn && selectedCards.length > 0 ? 'block' : 'none';
            }
        }
        
        function applyCardEffect(card) {
            // Mostrar explicaciÃ³n del comodÃ­n
            showWildcardExplanation(card);
            
            switch (card.value) {
                case '2': // Paso
                    set(ref(database, `games/${gameRoom}/skipNext`), true);
                    break;
                case '8': // Reversa
                    const newDirection = gameData.direction * -1;
                    set(ref(database, `games/${gameRoom}/direction`), newDirection);
                    break;
                case '10': // Barre
                    set(ref(database, `games/${gameRoom}/playPile`), []);
                    break;
                case 'Joker': // ComodÃ­n
                    // Por simplicidad, el Joker actÃºa como As
                    break;
            }
        }
        
        function showWildcardExplanation(card) {
            if (!['2', '8', '10', 'Joker'].includes(card.value)) return;
            
            // Solo mostrar para el jugador que jugÃ³ la carta
            const playerIds = Object.keys(gameData.players);
            if (playerIds[gameData.currentPlayer] !== myPlayerId) return;
            
            const modal = document.getElementById('wildcardModal');
            const title = document.getElementById('wildcardTitle');
            const content = document.getElementById('wildcardContent');
            
            let explanation = '';
            
            switch (card.value) {
                case '2':
                    title.innerHTML = 'ğŸš« Carta PASO (2)';
                    explanation = `
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="font-size: 64px; margin: 20px 0;">ğŸš«</div>
                            <h3 style="color: #ef4444; margin: 15px 0;">El siguiente jugador pierde su turno</h3>
                            <p style="font-size: 16px; line-height: 1.6;">La carta "2" hace que el siguiente jugador en la secuencia se salte su turno y pase al siguiente.</p>
                            <div class="wildcard-effect">
                                <strong>ğŸ¯ Efecto:</strong> Jugador actual â†’ Siguiente SALTADO â†’ Siguiente jugador juega
                            </div>
                        </div>
                    `;
                    break;
                case '8':
                    title.innerHTML = 'ğŸ”„ Carta REVERSA (8)';
                    explanation = `
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="font-size: 64px; margin: 20px 0;">ğŸ”„</div>
                            <h3 style="color: #8b5cf6; margin: 15px 0;">Cambia la direcciÃ³n del juego</h3>
                            <p style="font-size: 16px; line-height: 1.6;">La carta "8" invierte el orden de los turnos. Si iba en sentido horario, ahora va antihorario y viceversa.</p>
                            <div class="wildcard-effect">
                                <strong>ğŸ”„ Efecto:</strong> DirecciÃ³n del juego se invierte completamente
                            </div>
                        </div>
                    `;
                    break;
                case '10':
                    title.innerHTML = 'ğŸ§¹ Carta BARRE (10)';
                    explanation = `
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="font-size: 64px; margin: 20px 0;">ğŸ§¹</div>
                            <h3 style="color: #f59e0b; margin: 15px 0;">Elimina todas las cartas del centro</h3>
                            <p style="font-size: 16px; line-height: 1.6;">La carta "10" barre y elimina todas las cartas que estÃ©n en el centro de la mesa.</p>
                            <div class="wildcard-effect">
                                <strong>ğŸ§¹ Efecto:</strong> Mesa queda vacÃ­a, cualquier carta se puede jugar despuÃ©s
                            </div>
                        </div>
                    `;
                    break;
                case 'Joker':
                    title.innerHTML = 'ğŸƒ JOKER - ComodÃ­n';
                    explanation = `
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="font-size: 64px; margin: 20px 0;">ğŸƒ</div>
                            <h3 style="color: #10b981; margin: 15px 0;">Carta comodÃ­n universal</h3>
                            <p style="font-size: 16px; line-height: 1.6;">El Joker se puede jugar en cualquier momento y sobre cualquier carta.</p>
                            <div class="wildcard-effect">
                                <strong>ğŸƒ Efecto:</strong> ActÃºa como la carta de mayor valor (As) para el siguiente jugador
                            </div>
                        </div>
                    `;
                    break;
            }
            
            content.innerHTML = explanation;
            modal.style.display = 'block';
        }
        
        function renderPlayArea() {
            const playPile = gameData.playPile || [];
            let html = '<h3>Mesa de juego</h3>';
            
            if (playPile.length === 0) {
                html += '<div class="card card-back">VacÃ­a</div>';
            } else {
                const topCard = playPile[playPile.length - 1];
                html += `<div class="card card-front ${topCard.color}">
                    ${topCard.value}${topCard.suit}
                </div>`;
            }
            
            document.getElementById('playArea').innerHTML = html;
        }
        
        window.playFaceDownCard = function(index) {
            const playerIds = Object.keys(gameData.players);
            if (playerIds[gameData.currentPlayer] !== myPlayerId) return;
            
            const myPlayer = gameData.players[myPlayerId];
            if (!myPlayer.faceDown || myPlayer.faceDown.length <= index) return;
            
            // Solo se puede usar si no hay cartas en mano ni boca arriba
            if ((myPlayer.hand?.length || 0) > 0 || (myPlayer.faceUp?.length || 0) > 0) {
                alert('Solo puedes usar cartas boca abajo cuando no tengas otras cartas disponibles');
                return;
            }
            
            const card = myPlayer.faceDown[index];
            
            // Remover carta boca abajo
            myPlayer.faceDown.splice(index, 1);
            
            // Agregar a la pila de juego
            const playPile = gameData.playPile || [];
            playPile.push(card);
            
            // Aplicar efectos
            applyCardEffect(card);
            
            // Actualizar total de cartas
            myPlayer.totalCards = (myPlayer.faceDown?.length || 0) + 
                                 (myPlayer.faceUp?.length || 0) + 
                                 (myPlayer.hand?.length || 0);
            
            // Verificar victoria
            if (myPlayer.totalCards === 0) {
                showVictory(myPlayer.name, 'ğŸ¯ Â¡Sin cartas!');
                return;
            }
            
            // Verificar si la carta se puede jugar
            const topCard = playPile.length > 1 ? playPile[playPile.length - 2] : null;
            if (topCard && !canPlayCardValue(card, topCard)) {
                // Si no se puede jugar, el jugador recoge toda la pila
                myPlayer.hand = myPlayer.hand || [];
                myPlayer.hand.push(...playPile);
                myPlayer.totalCards += playPile.length;
                set(ref(database, `games/${gameRoom}/playPile`), []);
                alert('Â¡No se pudo jugar la carta! Recoges toda la pila.');
            }
            
            // Actualizar base de datos
            set(ref(database, `games/${gameRoom}/players/${myPlayerId}`), myPlayer);
            set(ref(database, `games/${gameRoom}/playPile`), playPile);
            
            nextTurn();
        };
        
        function canPlayCardValue(card, topCard) {
            if (['2', '8', '10', 'Joker'].includes(card.value)) return true;
            return getCardOrder(card.value) >= getCardOrder(topCard.value);
        }
        
        let swapSelection = null;
        
        window.swapCard = function(source, index) {
            if (gameData.gamePhase !== 'setup') return;
            
            const myPlayer = gameData.players[myPlayerId];
            
            if (!swapSelection) {
                // Primera selecciÃ³n
                swapSelection = { source, index };
                renderPlayerArea(myPlayer); // Re-renderizar para mostrar selecciÃ³n
            } else {
                // Segunda selecciÃ³n - hacer intercambio
                const card1 = swapSelection.source === 'hand' ? myPlayer.hand[swapSelection.index] : myPlayer.faceUp[swapSelection.index];
                const card2 = source === 'hand' ? myPlayer.hand[index] : myPlayer.faceUp[index];
                
                // Intercambiar cartas
                if (swapSelection.source === 'hand') {
                    myPlayer.hand[swapSelection.index] = card2;
                } else {
                    myPlayer.faceUp[swapSelection.index] = card2;
                }
                
                if (source === 'hand') {
                    myPlayer.hand[index] = card1;
                } else {
                    myPlayer.faceUp[index] = card1;
                }
                
                // Actualizar en base de datos
                set(ref(database, `games/${gameRoom}/players/${myPlayerId}`), myPlayer);
                
                swapSelection = null;
            }
        };
        
        window.confirmSetup = function() {
            const isReady = gameData.setupComplete?.[myPlayerId];
            const updates = {};
            updates[`games/${gameRoom}/setupComplete/${myPlayerId}`] = !isReady;
            
            // Verificar si todos estÃ¡n listos
            const playerIds = Object.keys(gameData.players);
            const allReady = playerIds.every(id => gameData.setupComplete?.[id] || id === myPlayerId);
            
            if (allReady && !isReady) {
                // Iniciar el juego
                updates[`games/${gameRoom}/gamePhase`] = 'playing';
            }
            
            Object.keys(updates).forEach(path => {
                set(ref(database, path), updates[path]);
            });
        };
        
        // Event listeners
        document.getElementById('startGameBtn').onclick = startGame;
        document.getElementById('resetRoomBtn').onclick = resetRoom;
        document.getElementById('endTurnBtn').onclick = endTurn;
        document.getElementById('playAgainBtn').onclick = () => {
            document.getElementById('victoryModal').style.display = 'none';
            location.reload();
        };
        
        document.getElementById('infoBtn').onclick = () => {
            document.getElementById('infoModal').style.display = 'block';
        };
        document.querySelector('.close').onclick = () => {
            document.getElementById('infoModal').style.display = 'none';
        };
        
        // Event listeners para modal de comodines
        document.querySelector('.close-wildcard').onclick = () => {
            document.getElementById('wildcardModal').style.display = 'none';
        };
        document.getElementById('wildcardOkBtn').onclick = () => {
            document.getElementById('wildcardModal').style.display = 'none';
        };
        
        // Cerrar modales al hacer clic fuera
        window.onclick = (event) => {
            const infoModal = document.getElementById('infoModal');
            const wildcardModal = document.getElementById('wildcardModal');
            if (event.target === infoModal) {
                infoModal.style.display = 'none';
            }
            if (event.target === wildcardModal) {
                wildcardModal.style.display = 'none';
            }
        };
        
        document.getElementById('playerName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinGame();
        });
    </script>
</body>
</html>