<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tercias Online</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f4c3a, #2d8659);
        }
        .login-form {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        .login-form input {
            padding: 10px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            width: 200px;
        }
        .waiting-room {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            margin: 20px;
        }
        .card.playable {
            border: 2px solid #22c55e;
            cursor: pointer;
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .card.selected {
            border: 3px solid #fbbf24;
            transform: translateY(-10px);
            box-shadow: 0 6px 12px rgba(251, 191, 36, 0.5);
        }
        .card-row {
            display: flex;
            gap: 3px;
            justify-content: center;
            margin: 5px;
        }
        .card {
            width: 50px;
            height: 75px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            border: 1px solid #333;
        }
        .card[draggable="true"] {
            cursor: grab;
        }
        .card[draggable="true"]:active {
            cursor: grabbing;
        }
        .drop-zone {
            min-height: 120px;
            border: 2px dashed #22c55e;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            background: rgba(34, 197, 94, 0.1);
        }
        .drop-zone.drag-over {
            background: rgba(34, 197, 94, 0.3);
            border-color: #16a34a;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .exit-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .joker-option {
            background: #22c55e;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .joker-option:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .card.transformed {
            border: 2px solid #f59e0b;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
    </style>
</head>
<body>
    <!-- Pantalla de login -->
    <div id="loginScreen" class="login-screen">
        <div class="login-form">
            <h1>üÉè Tercias Online</h1>
            <p>Ingresa tu nombre y sala para jugar</p>
            <div style="font-size: 12px; color: #ccc; margin: 10px 0; font-style: italic;">Creado y desarrollado por Silverio Diaz Ordaz y Nauhl Valdez su panita</div>
            <input type="text" id="playerName" placeholder="Tu nombre" maxlength="15">
            <br>
            <input type="text" id="roomId" placeholder="Sala (4 d√≠gitos)" maxlength="4" style="text-align: center;">
            <br>
            <button onclick="joinGame()">Unirse al Juego</button>
            <button id="adminBtn" onclick="clearAllSessions()" style="display: none; background: #dc2626; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">üóëÔ∏è Cerrar todas las sesiones</button>
        </div>
    </div>
    
    <!-- Sala de espera -->
    <div id="waitingRoom" class="waiting-room" style="display: none;">
        <h2>üïê Sala de Espera</h2>
        <p>Sala: <span id="roomDisplay" style="font-weight: bold; color: #22c55e;"></span></p>
        <div style="font-size: 12px; color: #ccc; margin: 10px 0; font-style: italic;">Creado y desarrollado por Silverio Diaz Ordaz y Nauhl Valdez su panita</div>
        <div id="playersList"></div>
        <p>Jugadores conectados: <span id="playerCount">0</span></p>
        <button id="startGameBtn" style="display: none; margin-top: 15px; padding: 10px 20px; font-size: 16px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer;">üéÆ Iniciar Juego</button>
        <button id="rulesBtn" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 5px;">üìã Reglas</button>
        <button id="exitRoomBtn" class="exit-btn">üö™ Salir</button>
    </div>
    
    <!-- Juego principal -->
    <div id="gameScreen" class="container" style="display: none; padding: 20px; max-width: 1200px; margin: 0 auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1>üÉè Tercias Online</h1>
                <div style="font-size: 12px; color: #ccc; font-style: italic;">Creado y desarrollado por Silverio Diaz Ordaz y Nauhl Valdez su panita</div>
            </div>
            <div>
                <button id="gameRulesBtn" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 5px;">üìã Reglas</button>
                <button id="exitGameBtn" class="exit-btn">üö™ Salir</button>
            </div>
        </div>
        
        <!-- Mesa de juego con jugadores alrededor -->
        <div style="display: grid; grid-template-areas: 'top-left top-center top-right' 'left center right' 'bottom-left bottom-center bottom-right'; grid-template-columns: 1fr 2fr 1fr; grid-template-rows: auto 1fr auto; gap: 20px; min-height: 600px;">
            
            <!-- Jugador superior -->
            <div style="grid-area: top-center;" id="player-top"></div>
            
            <!-- Jugador izquierdo -->
            <div style="grid-area: left; display: flex; flex-direction: column; justify-content: center;" id="player-left"></div>
            
            <!-- Centro: Mesa de juego -->
            <div style="grid-area: center; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div class="current-player">
                    <h3>Turno de: <span id="currentPlayerName">-</span></h3>
                    <div id="directionIndicator" style="font-size: 24px; margin: 10px 0; transition: transform 0.5s ease;">üîÑ</div>
                </div>
                <div class="play-area" id="playArea"></div>
                <div class="controls" style="margin-top: 20px;">
                    <button id="playSelectedBtn" style="display: none; padding: 12px 24px; font-size: 16px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px;">Jugar Seleccionadas</button>
                    <button id="clearSelectionBtn" style="display: none; padding: 12px 24px; font-size: 16px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px;">Limpiar Selecci√≥n</button>
                    <button id="endTurnBtn" style="padding: 12px 24px; font-size: 16px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer;">No puedo jugar (Comer cartas)</button>
                </div>
            </div>
            
            <!-- Jugador derecho -->
            <div style="grid-area: right; display: flex; flex-direction: column; justify-content: center;" id="player-right"></div>
            
            <!-- Jugador inferior (yo) -->
            <div style="grid-area: bottom-center;" id="player-bottom"></div>
        </div>
    </div>
    
    <!-- Modal de Joker -->
    <div id="jokerModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h2>üÉè Elige el valor del Joker</h2>
            <p>Selecciona qu√© carta quieres que represente el Joker:</p>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0;">
                <button onclick="selectJokerValue('3')" class="joker-option">3</button>
                <button onclick="selectJokerValue('4')" class="joker-option">4</button>
                <button onclick="selectJokerValue('5')" class="joker-option">5</button>
                <button onclick="selectJokerValue('6')" class="joker-option">6</button>
                <button onclick="selectJokerValue('7')" class="joker-option">7</button>
                <button onclick="selectJokerValue('9')" class="joker-option">9</button>
                <button onclick="selectJokerValue('J')" class="joker-option">J</button>
                <button onclick="selectJokerValue('Q')" class="joker-option">Q</button>
                <button onclick="selectJokerValue('K')" class="joker-option">K</button>
                <button onclick="selectJokerValue('A')" class="joker-option">A</button>
                <button onclick="selectJokerValue('2')" class="joker-option" style="background: #f59e0b;">2 (Paso)</button>
                <button onclick="selectJokerValue('8')" class="joker-option" style="background: #8b5cf6;">8 (Reversa)</button>
                <button onclick="selectJokerValue('10')" class="joker-option" style="background: #ef4444;">10 (Barre)</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de reglas -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>üìã C√≥mo Jugar Tercias</h2>
            <div class="rules">
                <h3>üéØ Objetivo:</h3>
                <p>Eliminar todas tus cartas para ganar.</p>
                
                <h3>üéÆ Configuraci√≥n inicial:</h3>
                <ul>
                    <li>Cada jugador recibe 9 cartas: 3 boca abajo, 3 boca arriba, 3 en mano</li>
                    <li>El jugador con la carta m√°s baja (3) en su mano empieza</li>
                </ul>
                
                <h3>üéØ Reglas de juego:</h3>
                <ul>
                    <li>Juega carta igual o mayor valor que la del centro</li>
                    <li>Si no puedes jugar, "comes" todas las cartas del centro</li>
                    <li><strong>Puedes jugar m√∫ltiples cartas del mismo valor:</strong> Haz click en las cartas para seleccionarlas y luego presiona "Jugar Seleccionadas"</li>
                    <li>Secuencia: usa mano ‚Üí cartas boca arriba ‚Üí cartas boca abajo</li>
                </ul>
                
                <h3>üÉè Cartas Especiales:</h3>
                <ul>
                    <li><strong>2:</strong> Paso - el siguiente jugador pierde turno</li>
                    <li><strong>8:</strong> Reversa - cambia direcci√≥n del juego</li>
                    <li><strong>10:</strong> Barre - elimina todas las cartas del centro</li>
                    <li><strong>Joker:</strong> Comod√≠n - se puede jugar sobre cualquier carta</li>
                </ul>
                
                <h3>üìä Orden de cartas:</h3>
                <p><strong>De menor a mayor:</strong> 3, 4, 5, 6, 7, 9, J, Q, K, <strong>As</strong></p>
                <p><strong>Comodines:</strong> 2, 8, 10, Joker (se pueden jugar sobre cualquier carta)</p>
                <p><strong>Nota:</strong> El As es la carta m√°s alta y puede jugarse sobre cualquier carta normal</p>
                
                <h3>üèÅ C√≥mo ganar:</h3>
                <ol>
                    <li>Elimina todas las cartas de tu mano</li>
                    <li>Luego usa las 3 cartas boca arriba</li>
                    <li>Finalmente usa las 3 cartas boca abajo (sin verlas antes)</li>
                    <li>¬°Ganas al jugar tu √∫ltima carta!</li>
                </ol>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAODDKrWgFHsOoTyS4CIeF6m83nADUfzyo",
            authDomain: "cartablas-game.firebaseapp.com",
            databaseURL: "https://cartablas-game-default-rtdb.firebaseio.com",
            projectId: "cartablas-game",
            storageBucket: "cartablas-game.firebasestorage.app",
            messagingSenderId: "986320435667",
            appId: "1:986320435667:web:075fa8945c8036b479d726",
            measurementId: "G-F8T0SGYWN2"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let myPlayerId = null;
        let gameRoom = null;
        let gameData = { players: {}, currentPlayer: 0, gameStarted: false };
        let selectedCards = [];
        let swapPhase = false;
        let multiSelectMode = false;
        
        // Generar sala aleatoria al cargar
        window.addEventListener('load', () => {
            const randomRoom = Math.floor(Math.random() * 9000) + 1000;
            document.getElementById('roomId').value = randomRoom;
        });
        
        // Unirse al juego
        window.joinGame = function() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomId = document.getElementById('roomId').value.trim();
            
            if (!playerName || !roomId || roomId.length !== 4) {
                alert('Completa todos los campos correctamente');
                return;
            }
            
            gameRoom = 'room_' + roomId;
            myPlayerId = 'player_' + Date.now();
            
            set(ref(database, `games/${gameRoom}/players/${myPlayerId}`), {
                name: playerName,
                hand: [],
                faceUp: [],
                faceDown: [],
                totalCards: 0
            }).then(() => {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('waitingRoom').style.display = 'block';
                listenToGame();
            });
        };
        
        function listenToGame() {
            const gameRef = ref(database, `games/${gameRoom}`);
            onValue(gameRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    gameData = data;
                    updateUI();
                }
            });
        }
        
        function updateUI() {
            const players = Object.values(gameData.players || {});
            
            if (!gameData.gameStarted) {
                updateWaitingRoom(players);
            } else {
                showGameScreen();
                updateGameUI();
            }
        }
        
        function updateWaitingRoom(players) {
            document.getElementById('roomDisplay').textContent = gameRoom.replace('room_', '');
            
            const playerColors = ['#3b82f6', '#ef4444', '#22c55e', '#f97316']; // Azul, Rojo, Verde, Naranja
            const playerColorsBg = ['rgba(59, 130, 246, 0.2)', 'rgba(239, 68, 68, 0.2)', 'rgba(34, 197, 94, 0.2)', 'rgba(249, 115, 22, 0.2)'];
            
            document.getElementById('playersList').innerHTML = players.map((p, i) => {
                const color = playerColors[i] || '#fff';
                const bgColor = playerColorsBg[i] || 'rgba(255,255,255,0.1)';
                return `<div style="padding: 10px; background: ${bgColor}; margin: 8px 0; border-radius: 8px; border: 2px solid ${color}; color: ${color}; font-weight: bold;">
                    üë§ ${i + 1}. ${p.name} ${Object.keys(gameData.players)[i] === myPlayerId ? '(T√∫)' : ''}
                </div>`;
            }).join('');
            
            document.getElementById('playerCount').textContent = players.length;
            
            const startGameBtn = document.getElementById('startGameBtn');
            if (players.length >= 1 && Object.keys(gameData.players)[0] === myPlayerId) {
                startGameBtn.style.display = 'block';
            } else {
                startGameBtn.style.display = 'none';
            }
        }
        
        window.startGame = function() {
            const players = Object.keys(gameData.players);
            const deck = createDeck();
            const updates = {};
            
            // Dar 9 cartas a cada jugador: 3 boca abajo, 3 boca arriba, 3 en mano
            players.forEach((playerId) => {
                const faceDown = [deck.pop(), deck.pop(), deck.pop()];
                const faceUp = [deck.pop(), deck.pop(), deck.pop()];
                const hand = [deck.pop(), deck.pop(), deck.pop()];
                
                updates[`games/${gameRoom}/players/${playerId}/faceDown`] = faceDown;
                updates[`games/${gameRoom}/players/${playerId}/faceUp`] = faceUp;
                updates[`games/${gameRoom}/players/${playerId}/hand`] = hand;
                updates[`games/${gameRoom}/players/${playerId}/totalCards`] = 9;
            });
            
            updates[`games/${gameRoom}/deck`] = deck;
            updates[`games/${gameRoom}/playPile`] = [];
            updates[`games/${gameRoom}/gameStarted`] = true;
            updates[`games/${gameRoom}/swapPhase`] = true;
            updates[`games/${gameRoom}/currentPlayer`] = 0;
            updates[`games/${gameRoom}/direction`] = 0; // 0 = horario (derecha), 1 = antihorario (izquierda)
            
            Object.keys(updates).forEach(path => {
                set(ref(database, path), updates[path]);
            });
        };
        
        function showGameScreen() {
            document.getElementById('waitingRoom').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
        }
        
        function updateGameUI() {
            const players = Object.values(gameData.players);
            const playerIds = Object.keys(gameData.players);
            swapPhase = gameData.swapPhase || false;
            
            if (swapPhase) {
                // Fase de intercambio
                document.getElementById('currentPlayerName').textContent = 'Fase de intercambio';
                document.getElementById('currentPlayerName').style.color = '#f59e0b';
                renderSwapArea();
            } else {
                // Mostrar turno actual con color
                if (players[gameData.currentPlayer]) {
                    const currentPlayerElement = document.getElementById('currentPlayerName');
                    const playerColors = ['#60a5fa', '#f87171', '#4ade80', '#fb923c']; // Colores m√°s claros para texto
                    const currentPlayerColor = playerColors[gameData.currentPlayer] || '#22c55e';
                    
                    currentPlayerElement.textContent = players[gameData.currentPlayer].name;
                    currentPlayerElement.style.color = currentPlayerColor;
                    currentPlayerElement.style.textShadow = `0 0 10px ${currentPlayerColor}50`;
                }
                
                // Mostrar √°rea de juego
                renderPlayArea();
            }
            
            // Actualizar indicador de direcci√≥n
            updateDirectionIndicator();
            
            // Distribuir jugadores alrededor de la mesa
            renderAllPlayers(players, playerIds);
        }
        
        function renderSwapArea() {
            let html = '<h3>Organiza tus cartas</h3>';
            html += '<p style="color: #ccc; font-size: 14px;">Arrastra cartas entre tu mano y cartas boca arriba</p>';
            html += '<button onclick="finishSwap()" style="padding: 10px 20px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px;">‚úÖ Listo</button>';
            document.getElementById('playArea').innerHTML = html;
        }
        
        function renderPlayArea() {
            const playPile = gameData.playPile || [];
            let html = '<h3>Mesa de juego</h3>';
            
            html += '<div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">';
            
            if (playPile.length === 0) {
                html += '<div style="color: #666; font-size: 18px;">Arrastra una carta aqu√≠</div>';
            } else {
                const topCard = playPile[playPile.length - 1];
                const displayValue = topCard.displayValue || topCard.value;
                const isTransformed = topCard.value === '2' && topCard.displayValue;
                
                html += `<div class="card card-front ${topCard.color} ${isTransformed ? 'transformed' : ''}">
                    ${displayValue}${topCard.suit}
                    ${isTransformed ? '<div style="font-size: 8px; position: absolute; bottom: 2px; right: 2px; opacity: 0.7;">(2)</div>' : ''}
                </div>`;
            }
            
            html += '</div>';
            document.getElementById('playArea').innerHTML = html;
        }
        
        function renderAllPlayers(players, playerIds) {
            const myPlayerIndex = playerIds.indexOf(myPlayerId);
            const totalPlayers = players.length;
            
            // Posiciones en sentido horario: abajo (yo), izquierda, arriba, derecha
            const positions = ['player-bottom', 'player-left', 'player-top', 'player-right'];
            
            // Mapeo de posiciones seg√∫n n√∫mero de jugadores (en sentido horario)
            const positionMaps = {
                2: [0, 2], // Yo abajo, otro arriba
                3: [0, 2, 1], // Yo abajo, siguiente arriba, siguiente izquierda
                4: [0, 1, 2, 3] // Yo abajo, izquierda, arriba, derecha
            };
            
            // Limpiar todas las posiciones
            positions.forEach(pos => {
                document.getElementById(pos).innerHTML = '';
            });
            
            const positionMap = positionMaps[totalPlayers] || positionMaps[4];
            
            players.forEach((player, index) => {
                const isMe = playerIds[index] === myPlayerId;
                const isCurrentPlayer = index === gameData.currentPlayer;
                
                // Calcular posici√≥n relativa en sentido horario
                let relativeIndex = (index - myPlayerIndex + totalPlayers) % totalPlayers;
                let positionIndex = positionMap[relativeIndex];
                const positionId = positions[positionIndex];
                
                const html = renderPlayerCards(player, playerIds[index], isMe, isCurrentPlayer);
                document.getElementById(positionId).innerHTML = html;
            });
        }
        
        function renderPlayerCards(player, playerId, isMe, isCurrentPlayer) {
            const playerIds = Object.keys(gameData.players);
            const playerIndex = playerIds.indexOf(playerId);
            const playerName = player.name + (isMe ? ' (T√∫)' : '');
            
            const playerAreaClass = `player-area-${playerIndex}`;
            const playerNameClass = `player-name-${playerIndex}`;
            const activeGlow = isCurrentPlayer ? 'style="box-shadow: 0 0 20px rgba(255, 255, 255, 0.3); transform: scale(1.02);"' : '';
            
            let html = `<div class="${playerAreaClass}" ${activeGlow}>`;
            html += `<h4 class="${playerNameClass}" style="text-align: center; margin-bottom: 15px; font-weight: bold;">${playerName}</h4>`;
            html += '<div style="display: flex; justify-content: center; gap: 20px; align-items: flex-start;">';
            
            // Cartas boca abajo (siempre como fila boca abajo)
            if ((player.faceDown?.length || 0) > 0) {
                html += '<div style="text-align: center;"><small style="color: #ccc;">Boca abajo</small><div class="card-row">';
                for (let i = 0; i < player.faceDown.length; i++) {
                    const draggable = isMe ? 'draggable="true" ondragstart="dragStart(event, \'faceDown\', ' + i + ')"' : '';
                    const playerCardClass = `player-${playerIndex}-card`;
                    html += `<div class="card card-back ${playerCardClass}" ${draggable}>?</div>`;
                }
                html += '</div></div>';
            }
            
            // Cartas boca arriba (visibles para todos en fila)
            if ((player.faceUp?.length || 0) > 0) {
                html += '<div style="text-align: center;"><small style="color: #ccc;">Boca arriba</small>';
                if (swapPhase && isMe) {
                    html += '<div class="drop-zone" style="min-height: 80px; margin: 5px;" ondrop="dropSwap(event, \'faceUp\')" ondragover="allowDrop(event)">';
                }
                html += '<div class="card-row">';
                player.faceUp.forEach((card, index) => {
                    const canPlay = isMe && (swapPhase || canPlayCard(card));
                    const draggable = (isMe && (swapPhase || canPlay)) ? `draggable="true" ondragstart="dragStart(event, 'faceUp', ${index})"` : '';
                    const dropEvents = (swapPhase && isMe) ? `ondrop="dropSwap(event, 'faceUp')" ondragover="allowDrop(event)"` : '';
                    const playerCardClass = `player-${playerIndex}-card`;
                    const isSelected = selectedCards.some(sc => sc.source === 'faceUp' && sc.index === index);
                    const clickEvent = (!swapPhase && isMe) ? `onclick="selectCard('faceUp', ${index})"` : '';
                    html += `<div class="card card-front ${card.color} ${canPlay ? 'playable' : ''} ${isSelected ? 'selected' : ''} ${playerCardClass}" ${draggable} ${dropEvents} ${clickEvent}>
                        ${card.value}${card.suit}
                    </div>`;
                });
                html += '</div>';
                if (swapPhase && isMe) {
                    html += '</div>';
                }
                html += '</div>';
            }
            
            // Cartas en mano
            if ((player.hand?.length || 0) > 0) {
                html += '<div style="text-align: center;"><small style="color: #ccc;">Mano</small><div style="display: flex; gap: 5px; justify-content: center; margin-top: 5px;">';
                
                if (isMe) {
                    if (swapPhase) {
                        html += '<div class="drop-zone" style="min-height: 80px; margin: 5px;" ondrop="dropSwap(event, \'hand\')" ondragover="allowDrop(event)">';
                    }
                    // Mostrar mis cartas
                    player.hand.forEach((card, index) => {
                        const canPlay = swapPhase || canPlayCard(card);
                        const draggable = (swapPhase || canPlay) ? `draggable="true" ondragstart="dragStart(event, 'hand', ${index})"` : '';
                        const dropEvents = (swapPhase && isMe) ? `ondrop="dropSwap(event, 'hand')" ondragover="allowDrop(event)"` : '';
                        const playerCardClass = `player-${playerIndex}-card`;
                        const isSelected = selectedCards.some(sc => sc.source === 'hand' && sc.index === index);
                        const clickEvent = !swapPhase ? `onclick="selectCard('hand', ${index})"` : '';
                        html += `<div class="card card-front ${card.color} ${canPlay ? 'playable' : ''} ${isSelected ? 'selected' : ''} ${playerCardClass}" ${draggable} ${dropEvents} ${clickEvent}>
                            ${card.value}${card.suit}
                        </div>`;
                    });
                    if (swapPhase) {
                        html += '</div>';
                    }
                } else {
                    // Mostrar cartas boca abajo para otros jugadores
                    for (let i = 0; i < player.hand.length; i++) {
                        const playerCardClass = `player-${playerIndex}-card`;
                        html += `<div class="card card-back ${playerCardClass}">?</div>`;
                    }
                }
                html += '</div></div>';
            }
            
            html += '</div>';
            html += `<div style="text-align: center; margin-top: 10px; font-size: 12px; color: #ccc;">${player.totalCards || 0} cartas totales</div>`;
            html += '</div>';
            
            return html;
        }
        
        // Drag and Drop functions
        let draggedCard = null;
        
        window.dragStart = function(event, source, index) {
            const playerIds = Object.keys(gameData.players);
            if (playerIds[gameData.currentPlayer] !== myPlayerId) {
                event.preventDefault();
                return;
            }
            
            // Validar que la carta se puede jugar (excepto en fase de intercambio)
            if (!swapPhase) {
                const myPlayer = gameData.players[myPlayerId];
                let cardArray;
                
                switch(source) {
                    case 'hand':
                        cardArray = myPlayer.hand;
                        break;
                    case 'faceUp':
                        cardArray = myPlayer.faceUp;
                        break;
                    case 'faceDown':
                        cardArray = myPlayer.faceDown;
                        break;
                    default:
                        event.preventDefault();
                        return;
                }
                
                if (cardArray && cardArray[index]) {
                    const card = cardArray[index];
                    // Solo permitir arrastrar cartas boca abajo o cartas que se pueden jugar
                    if (source !== 'faceDown' && !canPlayCard(card)) {
                        event.preventDefault();
                        return;
                    }
                }
            }
            
            draggedCard = { source, index };
            event.dataTransfer.effectAllowed = 'move';
        };
        
        window.allowDrop = function(event) {
            event.preventDefault();
        };
        
        window.dragEnter = function(event) {
            event.target.closest('.drop-zone').classList.add('drag-over');
        };
        
        window.dragLeave = function(event) {
            if (!event.target.closest('.drop-zone').contains(event.relatedTarget)) {
                event.target.closest('.drop-zone').classList.remove('drag-over');
            }
        };
        
        window.drop = function(event) {
            event.preventDefault();
            event.target.closest('.drop-zone').classList.remove('drag-over');
            
            if (!draggedCard) return;
            
            const { source, index } = draggedCard;
            if (swapPhase) {
                // En fase de intercambio, no se puede jugar cartas
                return;
            }
            playCard(source, index);
            draggedCard = null;
        };
        
        window.dropSwap = function(event, targetSource) {
            event.preventDefault();
            
            if (!draggedCard || !swapPhase) return;
            
            const { source, index } = draggedCard;
            
            // Solo permitir intercambio entre mano y faceUp
            if ((source === 'hand' && targetSource === 'faceUp') || 
                (source === 'faceUp' && targetSource === 'hand')) {
                
                // Obtener posici√≥n del drop
                const dropTarget = event.target.closest('.card');
                let targetIndex = -1;
                
                if (dropTarget) {
                    const cards = Array.from(dropTarget.parentElement.querySelectorAll('.card'));
                    targetIndex = cards.indexOf(dropTarget);
                }
                
                swapCards(source, index, targetSource, targetIndex);
            }
            
            draggedCard = null;
        };
        
        function swapCards(fromSource, fromIndex, toSource, toIndex = -1) {
            const myPlayer = gameData.players[myPlayerId];
            
            const fromArray = fromSource === 'hand' ? myPlayer.hand : myPlayer.faceUp;
            const toArray = toSource === 'hand' ? myPlayer.hand : myPlayer.faceUp;
            
            if (toIndex >= 0 && toIndex < toArray.length) {
                // Intercambio directo de cartas
                const temp = fromArray[fromIndex];
                fromArray[fromIndex] = toArray[toIndex];
                toArray[toIndex] = temp;
            } else if (toArray.length < 3) {
                // Mover carta si hay espacio
                const card = fromArray.splice(fromIndex, 1)[0];
                toArray.push(card);
            }
            
            set(ref(database, `games/${gameRoom}/players/${myPlayerId}`), myPlayer);
        }
        
        window.finishSwap = function() {
            set(ref(database, `games/${gameRoom}/swapPhase`), false);
        };
        
        window.selectCard = function(source, index) {
            const playerIds = Object.keys(gameData.players);
            if (playerIds[gameData.currentPlayer] !== myPlayerId || swapPhase) return;
            
            const myPlayer = gameData.players[myPlayerId];
            let cardArray = source === 'hand' ? myPlayer.hand : myPlayer.faceUp;
            if (!cardArray || !cardArray[index]) return;
            
            const card = cardArray[index];
            if (!canPlayCard(card)) return;
            
            const existingIndex = selectedCards.findIndex(sc => sc.source === source && sc.index === index);
            
            if (existingIndex >= 0) {
                // Deseleccionar carta
                selectedCards.splice(existingIndex, 1);
            } else {
                // Validar que todas las cartas seleccionadas sean del mismo valor
                if (selectedCards.length > 0) {
                    const firstCard = getCardFromSelection(selectedCards[0]);
                    if (firstCard && firstCard.value !== card.value) {
                        alert('Solo puedes seleccionar cartas del mismo valor');
                        return;
                    }
                }
                selectedCards.push({ source, index, value: card.value });
            }
            
            updateSelectionUI();
            updateGameUI();
        };
        
        function getCardFromSelection(selection) {
            const myPlayer = gameData.players[myPlayerId];
            const cardArray = selection.source === 'hand' ? myPlayer.hand : myPlayer.faceUp;
            return cardArray ? cardArray[selection.index] : null;
        }
        
        function updateSelectionUI() {
            const playSelectedBtn = document.getElementById('playSelectedBtn');
            const clearSelectionBtn = document.getElementById('clearSelectionBtn');
            
            if (selectedCards.length > 0) {
                playSelectedBtn.style.display = 'inline-block';
                clearSelectionBtn.style.display = 'inline-block';
                playSelectedBtn.textContent = `Jugar ${selectedCards.length} carta${selectedCards.length > 1 ? 's' : ''}`;
            } else {
                playSelectedBtn.style.display = 'none';
                clearSelectionBtn.style.display = 'none';
            }
        }
        
        window.playSelectedCards = function() {
            if (selectedCards.length === 0) return;
            
            // Ordenar por √≠ndice descendente para remover correctamente
            const sortedCards = [...selectedCards].sort((a, b) => {
                if (a.source !== b.source) return a.source === 'hand' ? -1 : 1;
                return b.index - a.index;
            });
            
            const myPlayer = gameData.players[myPlayerId];
            const playPile = gameData.playPile || [];
            const cardsToPlay = [];
            
            // Recopilar y remover cartas
            sortedCards.forEach(selection => {
                const cardArray = selection.source === 'hand' ? myPlayer.hand : myPlayer.faceUp;
                if (cardArray && cardArray[selection.index]) {
                    const card = cardArray.splice(selection.index, 1)[0];
                    cardsToPlay.push(card);
                }
            });
            
            // Agregar cartas a la pila
            cardsToPlay.forEach(card => {
                if (card.value === '2' && playPile.length > 0) {
                    const previousCard = playPile[playPile.length - 1];
                    card.displayValue = previousCard.displayValue || previousCard.value;
                } else {
                    card.displayValue = card.value;
                }
                playPile.push(card);
            });
            
            // Aplicar efectos solo de la √∫ltima carta jugada
            if (cardsToPlay.length > 0) {
                applyCardEffect(cardsToPlay[cardsToPlay.length - 1]);
            }
            
            myPlayer.totalCards = (myPlayer.faceDown?.length || 0) + 
                                 (myPlayer.faceUp?.length || 0) + 
                                 (myPlayer.hand?.length || 0);
            
            if (myPlayer.totalCards === 0) {
                alert(`¬°${myPlayer.name} ha ganado!`);
                return;
            }
            
            selectedCards = [];
            updateSelectionUI();
            
            set(ref(database, `games/${gameRoom}/players/${myPlayerId}`), myPlayer);
            set(ref(database, `games/${gameRoom}/playPile`), playPile);
            nextTurn();
        };
        
        window.clearSelection = function() {
            selectedCards = [];
            updateSelectionUI();
            updateGameUI();
        };
        
        function playCard(source, index) {
            const playerIds = Object.keys(gameData.players);
            if (playerIds[gameData.currentPlayer] !== myPlayerId) return;
            
            const myPlayer = gameData.players[myPlayerId];
            let cardArray;
            
            switch(source) {
                case 'hand':
                    cardArray = myPlayer.hand;
                    break;
                case 'faceUp':
                    cardArray = myPlayer.faceUp;
                    break;
                case 'faceDown':
                    cardArray = myPlayer.faceDown;
                    break;
                default:
                    return;
            }
            
            if (!cardArray || !cardArray[index]) return;
            
            const card = cardArray[index];
            
            // Verificar si se puede jugar (excepto cartas boca abajo)
            if (source !== 'faceDown' && !canPlayCard(card)) {
                alert('No puedes jugar esta carta. Debes comer las cartas del centro.');
                return;
            }
            
            // Si es carta boca abajo, verificar despu√©s de revelarla
            if (source === 'faceDown') {
                const playPile = gameData.playPile || [];
                if (playPile.length > 0 && !canPlayCard(card)) {
                    // La carta boca abajo no se puede jugar, el jugador debe comer todas las cartas
                    alert(`Revelaste un ${card.value}${card.suit} pero no se puede jugar. Debes comer todas las cartas.`);
                    
                    // Devolver la carta a boca abajo y hacer que coma cartas
                    myPlayer.hand = myPlayer.hand || [];
                    myPlayer.hand.push(card); // Agregar la carta revelada a la mano
                    myPlayer.hand.push(...playPile); // Agregar todas las cartas del centro
                    
                    myPlayer.totalCards = (myPlayer.faceDown?.length || 0) + 
                                         (myPlayer.faceUp?.length || 0) + 
                                         myPlayer.hand.length;
                    
                    set(ref(database, `games/${gameRoom}/playPile`), []);
                    set(ref(database, `games/${gameRoom}/players/${myPlayerId}`), myPlayer);
                    nextTurn();
                    return;
                }
            }
            
            // Remover carta y agregarla a la pila
            cardArray.splice(index, 1);
            const playPile = gameData.playPile || [];
            
            // Si es un 2, mantener el valor de la carta anterior
            if (card.value === '2' && playPile.length > 0) {
                const previousCard = playPile[playPile.length - 1];
                card.displayValue = previousCard.displayValue || previousCard.value;
            } else {
                card.displayValue = card.value;
            }
            
            playPile.push(card);
            
            applyCardEffect(card);
            
            myPlayer.totalCards = (myPlayer.faceDown?.length || 0) + 
                                 (myPlayer.faceUp?.length || 0) + 
                                 (myPlayer.hand?.length || 0);
            
            if (myPlayer.totalCards === 0) {
                alert(`¬°${myPlayer.name} ha ganado!`);
                return;
            }
            
            set(ref(database, `games/${gameRoom}/players/${myPlayerId}`), myPlayer);
            set(ref(database, `games/${gameRoom}/playPile`), playPile);
            nextTurn();
        }
        

        
        window.endTurn = function() {
            const playerIds = Object.keys(gameData.players);
            if (playerIds[gameData.currentPlayer] !== myPlayerId) return;
            
            // Verificar si realmente no se puede jugar
            if (hasPlayableCard()) {
                alert('¬°A√∫n tienes cartas que puedes jugar! Revisa tu mano y cartas boca arriba.');
                return;
            }
            
            // Comer cartas
            const myPlayer = gameData.players[myPlayerId];
            const playPile = gameData.playPile || [];
            
            if (playPile.length > 0) {
                myPlayer.hand = myPlayer.hand || [];
                myPlayer.hand.push(...playPile);
                myPlayer.totalCards = (myPlayer.faceDown?.length || 0) + 
                                     (myPlayer.faceUp?.length || 0) + 
                                     myPlayer.hand.length;
                
                set(ref(database, `games/${gameRoom}/playPile`), []);
                set(ref(database, `games/${gameRoom}/players/${myPlayerId}`), myPlayer);
                
                // Mostrar mensaje informativo
                const message = document.createElement('div');
                message.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(220, 38, 38, 0.9); color: white; padding: 15px 25px; border-radius: 10px; font-size: 16px; font-weight: bold; z-index: 1000; animation: fadeInOut 2s ease-in-out;';
                message.textContent = `¬°Comiste ${playPile.length} carta${playPile.length > 1 ? 's' : ''}!`;
                document.body.appendChild(message);
                setTimeout(() => document.body.removeChild(message), 2000);
            }
            
            nextTurn();
        };
        
        function nextTurn() {
            const playerIds = Object.keys(gameData.players);
            const totalPlayers = playerIds.length;
            let nextPlayerIndex;
            
            if (gameData.direction === 0) {
                // Horario (derecha): +1
                nextPlayerIndex = (gameData.currentPlayer + 1) % totalPlayers;
            } else {
                // Antihorario (izquierda): -1
                nextPlayerIndex = (gameData.currentPlayer - 1 + totalPlayers) % totalPlayers;
            }
            
            set(ref(database, `games/${gameRoom}/currentPlayer`), nextPlayerIndex);
        }
        
        function applyCardEffect(card) {
            switch (card.value) {
                case '2': // Paso
                    nextTurn(); // Saltar siguiente jugador
                    break;
                case '8': // Reversa
                    const newDirection = gameData.direction === 0 ? 1 : 0; // Cambiar entre 0 y 1
                    set(ref(database, `games/${gameRoom}/direction`), newDirection);
                    showDirectionChange(newDirection);
                    break;
                case '10': // Barre
                    set(ref(database, `games/${gameRoom}/playPile`), []);
                    break;
                case 'Joker': // Comod√≠n
                    showJokerSelection();
                    break;
            }
        }
        
        function canPlayCard(card) {
            const playPile = gameData.playPile || [];
            if (playPile.length === 0) return true;
            
            const topCard = playPile[playPile.length - 1];
            const topCardValue = topCard.displayValue || topCard.value;
            
            // Cartas especiales siempre se pueden jugar
            if (['2', '8', '10', 'Joker'].includes(card.value)) return true;
            
            // Carta normal debe ser igual o mayor que el valor mostrado
            return getCardOrder(card.value) >= getCardOrder(topCardValue);
        }
        
        function hasPlayableCard() {
            const myPlayer = gameData.players[myPlayerId];
            if (!myPlayer) return false;
            
            // Verificar cartas en mano
            if (myPlayer.hand && myPlayer.hand.length > 0) {
                return myPlayer.hand.some(card => canPlayCard(card));
            }
            
            // Verificar cartas boca arriba si no hay cartas en mano
            if (myPlayer.faceUp && myPlayer.faceUp.length > 0) {
                return myPlayer.faceUp.some(card => canPlayCard(card));
            }
            
            // Si solo quedan cartas boca abajo, siempre se puede intentar jugar
            return myPlayer.faceDown && myPlayer.faceDown.length > 0;
        }
        
        function getCardOrder(value) {
            const order = { '3': 1, '4': 2, '5': 3, '6': 4, '7': 5, '9': 6, 'J': 7, 'Q': 8, 'K': 9, 'A': 11, '2': 0, '8': 0, '10': 0, 'Joker': 0 };
            return order[value] || 0;
        }
        
        function createDeck() {
            const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
            const values = ['3', '4', '5', '6', '7', '9', 'J', 'Q', 'K', 'A', '2', '8', '10'];
            const deck = [];
            
            for (let suit of suits) {
                for (let value of values) {
                    deck.push({
                        suit: suit,
                        value: value,
                        color: (suit === '‚ô•' || suit === '‚ô¶') ? 'red' : 'black'
                    });
                }
            }
            
            // Agregar 2 Jokers
            deck.push({ suit: 'üÉè', value: 'Joker', color: 'joker' });
            deck.push({ suit: 'üÉè', value: 'Joker', color: 'joker' });
            
            // Barajar
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            
            return deck;
        }
        
        // Salir de la sala
        window.exitRoom = function() {
            if (myPlayerId && gameRoom) {
                const playerRef = ref(database, `games/${gameRoom}/players/${myPlayerId}`);
                remove(playerRef);
            }
            location.reload();
        };
        
        function updateDirectionIndicator() {
            const indicator = document.getElementById('directionIndicator');
            if (indicator) {
                if (gameData.direction === 0) {
                    // Horario (derecha)
                    indicator.innerHTML = '‚ü≥'; // ‚ü≥
                    indicator.style.transform = 'rotate(0deg)';
                    indicator.title = 'Sentido horario';
                } else {
                    // Antihorario (izquierda)
                    indicator.innerHTML = '‚ü≤'; // ‚ü≤
                    indicator.style.transform = 'rotate(180deg)';
                    indicator.title = 'Sentido antihorario';
                }
            }
        }
        
        function showDirectionChange(newDirection) {
            const indicator = document.getElementById('directionIndicator');
            if (indicator) {
                // Animaci√≥n de cambio
                indicator.style.transform = 'scale(1.5) rotate(360deg)';
                indicator.style.color = '#f59e0b';
                
                setTimeout(() => {
                    updateDirectionIndicator();
                    indicator.style.color = '#22c55e';
                    
                    setTimeout(() => {
                        indicator.style.transform = newDirection === 0 ? 'rotate(0deg)' : 'rotate(180deg)';
                    }, 100);
                }, 500);
                
                // Mostrar mensaje
                const message = document.createElement('div');
                message.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(245, 158, 11, 0.9); color: white; padding: 15px 25px; border-radius: 10px; font-size: 18px; font-weight: bold; z-index: 1000; animation: fadeInOut 2s ease-in-out;';
                message.textContent = newDirection === 0 ? 'üîÑ ¬°Cambio a sentido horario!' : 'üîÑ ¬°Cambio a sentido antihorario!';
                
                // Agregar animaci√≥n CSS
                const style = document.createElement('style');
                style.textContent = '@keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } }';
                document.head.appendChild(style);
                
                document.body.appendChild(message);
                setTimeout(() => {
                    document.body.removeChild(message);
                    document.head.removeChild(style);
                }, 2000);
            }
        }
        
        function showJokerSelection() {
            document.getElementById('jokerModal').style.display = 'block';
        }
        
        window.selectJokerValue = function(value) {
            document.getElementById('jokerModal').style.display = 'none';
            
            // Crear carta virtual con el valor seleccionado
            const virtualCard = { value: value };
            
            // Aplicar efecto seg√∫n el valor seleccionado
            switch (value) {
                case '2': // Paso
                    nextTurn(); // Saltar siguiente jugador
                    showJokerEffect('2', 'üö´ Joker como PASO - Siguiente jugador pierde turno');
                    break;
                case '8': // Reversa
                    const newDirection = gameData.direction === 0 ? 1 : 0;
                    set(ref(database, `games/${gameRoom}/direction`), newDirection);
                    showDirectionChange(newDirection);
                    showJokerEffect('8', 'üîÑ Joker como REVERSA - Cambio de direcci√≥n');
                    break;
                case '10': // Barre
                    set(ref(database, `games/${gameRoom}/playPile`), []);
                    showJokerEffect('10', 'üßπ Joker como BARRE - Mesa limpia');
                    break;
                default:
                    showJokerEffect(value, `üÉè Joker como ${value} - Carta normal`);
                    break;
            }
        };
        
        function showJokerEffect(value, message) {
            const effectMessage = document.createElement('div');
            effectMessage.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(16, 185, 129, 0.9); color: white; padding: 20px 30px; border-radius: 15px; font-size: 18px; font-weight: bold; z-index: 1001; animation: jokerEffect 3s ease-in-out;';
            effectMessage.innerHTML = `<div style="font-size: 24px; margin-bottom: 10px;">üÉè‚û°Ô∏è${value}</div><div>${message}</div>`;
            
            // Agregar animaci√≥n CSS
            const style = document.createElement('style');
            style.textContent = '@keyframes jokerEffect { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3) rotate(-10deg); } 20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1) rotate(5deg); } 80% { opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(0deg); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8) rotate(10deg); } }';
            document.head.appendChild(style);
            
            document.body.appendChild(effectMessage);
            setTimeout(() => {
                document.body.removeChild(effectMessage);
                document.head.removeChild(style);
            }, 3000);
        }
        
        // Event listeners
        document.getElementById('startGameBtn').onclick = startGame;
        document.getElementById('endTurnBtn').onclick = endTurn;
        document.getElementById('playSelectedBtn').onclick = playSelectedCards;
        document.getElementById('clearSelectionBtn').onclick = clearSelection;
        document.getElementById('rulesBtn').onclick = () => {
            document.getElementById('rulesModal').style.display = 'block';
        };
        document.getElementById('gameRulesBtn').onclick = () => {
            document.getElementById('rulesModal').style.display = 'block';
        };
        document.getElementById('exitRoomBtn').onclick = exitRoom;
        document.getElementById('exitGameBtn').onclick = exitRoom;
        
        document.querySelector('.close').onclick = () => {
            document.getElementById('rulesModal').style.display = 'none';
        };
        
        window.onclick = (event) => {
            const modal = document.getElementById('rulesModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
        
        document.getElementById('playerName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('roomId').focus();
        });
        
        document.getElementById('playerName').addEventListener('input', (e) => {
            const adminBtn = document.getElementById('adminBtn');
            if (e.target.value.toLowerCase() === 'administrador') {
                adminBtn.style.display = 'block';
            } else {
                adminBtn.style.display = 'none';
            }
        });
        
        window.clearAllSessions = function() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar todas las sesiones activas?')) {
                set(ref(database, 'games'), null).then(() => {
                    alert('Todas las sesiones han sido cerradas');
                    location.reload();
                });
            }
        };
        
        document.getElementById('roomId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinGame();
        });
        
        document.getElementById('roomId').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 4);
        });
        
        // Cerrar modal con Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('rulesModal').style.display = 'none';
            }
        });
    </script>
</body>
</html>